@using CampusConnectHub.Client.Services
@using CampusConnectHub.Shared.DTOs
@using Microsoft.JSInterop
@inject ApiService ApiService
@inject IJSRuntime JSRuntime

@if (eventId.HasValue)
{
    <div class="attendee-management-container">
        <div class="attendee-header">
            <h3>Event Attendees</h3>
            <div class="header-actions">
                <button class="btn-export" @onclick="ExportAttendees" disabled="@isExporting">
                    @if (isExporting)
                    {
                        <span>Exporting...</span>
                    }
                    else
                    {
                        <span>ðŸ“¥ Export CSV</span>
                    }
                </button>
                <button class="btn-close" @onclick="Close">âœ•</button>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading attendees...</p>
            </div>
        }
        else if (attendees.Any())
        {
            <div class="attendees-list">
                <div class="attendees-count">Total Attendees: @attendees.Count</div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>RSVP Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var attendee in attendees)
                        {
                            <tr>
                                <td>@attendee.UserName</td>
                                <td>@attendee.UserEmail</td>
                                <td>@attendee.RSVPDate.ToString("MMM dd, yyyy 'at' h:mm tt")</td>
                                <td>
                                    <span class="status-badge status-confirmed">@attendee.Status</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">ðŸ‘¥</div>
                <p>No attendees for this event yet</p>
            </div>
        }
    </div>
}

@code {
    [Parameter] public int? EventId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private List<EventAttendeeDto> attendees = new();
    private bool isLoading = true;
    private bool isExporting = false;
    private int? eventId => EventId;

    protected override async Task OnParametersSetAsync()
    {
        if (eventId.HasValue)
        {
            await LoadAttendees();
        }
    }

    private async Task LoadAttendees()
    {
        if (!eventId.HasValue) return;

        isLoading = true;
        try
        {
            attendees = await ApiService.GetEventAttendeesAsync(eventId.Value);
        }
        catch
        {
            attendees = new List<EventAttendeeDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExportAttendees()
    {
        if (!eventId.HasValue) return;

        isExporting = true;
        try
        {
            var csvData = await ApiService.ExportEventAttendeesAsync(eventId.Value);
            if (csvData != null)
            {
                var fileName = $"event-{eventId.Value}-attendees-{DateTime.UtcNow:yyyyMMdd}.csv";
                await DownloadFile(csvData, fileName, "text/csv");
            }
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task DownloadFile(byte[] data, string fileName, string contentType)
    {
        try
        {
            var base64 = Convert.ToBase64String(data);
            var bytes = Convert.FromBase64String(base64);
            var base64String = Convert.ToBase64String(bytes);
            
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const binaryString = atob('{base64String}');
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {{
                        bytes[i] = binaryString.charCodeAt(i);
                    }}
                    const blob = new Blob([bytes], {{ type: '{contentType}' }});
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '{fileName}';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }})();
            ");
        }
        catch (Exception ex)
        {
            // If download fails, show error
            Console.WriteLine($"Download failed: {ex.Message}");
        }
    }

    private void Close()
    {
        OnClose.InvokeAsync();
    }
}

<style>
    .attendee-management-container {
        background: var(--bg-glass);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .attendee-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .attendee-header h3 {
        margin: 0;
        color: var(--text-primary);
        font-size: var(--font-size-2xl);
        font-weight: 700;
    }

    .header-actions {
        display: flex;
        gap: var(--spacing-md);
    }

    .btn-export {
        padding: var(--spacing-sm) var(--spacing-lg);
        background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 700;
        transition: all var(--transition-base);
    }

    .btn-export:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-export:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-close {
        padding: var(--spacing-sm) var(--spacing-md);
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 700;
        transition: all var(--transition-base);
    }

    .btn-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .attendees-count {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
        font-weight: 700;
        font-size: var(--font-size-lg);
    }

    .attendees-list {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: rgba(255, 255, 255, 0.1);
    }

    th {
        padding: var(--spacing-md);
        text-align: left;
        color: var(--text-primary);
        font-weight: 700;
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        padding: var(--spacing-md);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .status-badge {
        display: inline-block;
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: 700;
        text-transform: uppercase;
    }

    .status-confirmed {
        background: rgba(39, 174, 96, 0.2);
        color: #27ae60;
    }

    .loading-container {
        text-align: center;
        padding: var(--spacing-2xl);
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto var(--spacing-md);
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-secondary);
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: var(--spacing-sm);
        opacity: 0.5;
    }

    @@media (max-width: 768px) {
        .attendee-header {
            flex-direction: column;
            align-items: stretch;
            gap: var(--spacing-md);
        }

        table {
            font-size: var(--font-size-sm);
        }

        th, td {
            padding: var(--spacing-sm);
        }
    }
</style>

