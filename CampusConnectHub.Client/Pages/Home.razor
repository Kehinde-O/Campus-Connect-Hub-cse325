@page "/"
@using CampusConnectHub.Client.Services
@using CampusConnectHub.Shared.DTOs
@inject ApiService ApiService
@inject AuthService AuthService

<PageTitle>Campus Connect Hub - News Feed</PageTitle>

<div class="content-header text-center mb-4">
    <h1 class="display-4 fw-bold text-primary">Campus News Feed</h1>
    <p class="lead text-secondary">Stay updated with the latest campus announcements</p>
</div>

<div class="container-fluid news-container">
    <div class="search-section mb-4">
        <SearchBar Placeholder="Search news posts..." 
                   OnSearch="HandleSearch" 
                   OnClear="HandleClearSearch" />
    </div>

    @if (isLoading)
    {
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="loading-spinner mb-3"></div>
            <p class="text-secondary">Loading news...</p>
        </div>
    }
    else if (newsPosts.Items.Any())
    {
        <div class="dashboard-grid">
            @foreach (var post in newsPosts.Items)
            {
                <div class="card news-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h3 class="card-title h5 text-primary mb-0">@post.Title</h3>
                            <div class="date-badge">
                                <span class="month">@post.CreatedAt.ToString("MMM")</span>
                                <span class="day">@post.CreatedAt.Day</span>
                            </div>
                        </div>
                        
                        <p class="card-text text-secondary mb-4 flex-grow-1">@post.Content</p>
                        
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <div class="author-info d-flex align-items-center gap-2">
                                <div class="author-avatar"><i class="bi bi-person-fill"></i></div>
                                <span class="text-secondary small">@post.AuthorName</span>
                            </div>
                            <span class="text-muted small">@post.CreatedAt.ToString("h:mm tt")</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (newsPosts.TotalPages > 1)
        {
            <div class="pagination-container d-flex justify-content-center align-items-center gap-2 mt-5">
                <button class="btn btn-secondary" disabled="@(newsPosts.PageNumber == 1)" 
                        @onclick="() => LoadPage(newsPosts.PageNumber - 1)">
                    <i class="bi bi-chevron-left me-1"></i> Previous
                </button>
                <div class="pagination-info px-3 text-secondary">
                    Page <strong>@newsPosts.PageNumber</strong> of <strong>@newsPosts.TotalPages</strong>
                </div>
                <button class="btn btn-secondary" disabled="@(newsPosts.PageNumber >= newsPosts.TotalPages)" 
                        @onclick="() => LoadPage(newsPosts.PageNumber + 1)">
                    Next <i class="bi bi-chevron-right ms-1"></i>
                </button>
            </div>
        }
    }
    else
    {
        <div class="empty-state text-center py-5">
            <div class="empty-icon mb-3">
                <i class="bi bi-newspaper display-1 text-tertiary"></i>
            </div>
            <h3 class="text-primary mb-2">No news posts available</h3>
            <p class="text-secondary">Check back later for the latest campus updates!</p>
        </div>
    }
</div>

@code {
    private PagedResponse<NewsPostDto> newsPosts = new();
    private bool isLoading = true;
    private string? currentSearch = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadNews();
    }

    private async Task LoadNews(int pageNumber = 1)
    {
        isLoading = true;
        try
        {
            newsPosts = await ApiService.GetNewsAsync(pageNumber, 10, currentSearch);
        }
        catch
        {
            newsPosts = new PagedResponse<NewsPostDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSearch(string searchText)
    {
        currentSearch = searchText;
        await LoadNews(1);
    }

    private async Task HandleClearSearch()
    {
        currentSearch = null;
        await LoadNews(1);
    }

    private async Task LoadPage(int pageNumber)
    {
        await LoadNews(pageNumber);
    }
}

<style>
    .news-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .news-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .news-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .date-badge {
        text-align: center;
        background-color: var(--bg-secondary);
        padding: 0.5rem 0.75rem;
        border-radius: var(--radius-md);
        min-width: 60px;
        border: 1px solid #e2e8f0;
    }

    .date-badge .month {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--secondary-color);
        line-height: 1;
        margin-bottom: 2px;
    }

    .date-badge .day {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .author-avatar {
        width: 24px;
        height: 24px;
        background-color: var(--bg-secondary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 0.75rem;
    }

    .text-tertiary {
        color: var(--text-tertiary);
    }
</style>
