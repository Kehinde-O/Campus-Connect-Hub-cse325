@page "/my-rsvps"
@using CampusConnectHub.Client.Services
@using CampusConnectHub.Shared.DTOs
@inject ApiService ApiService
@inject AuthService AuthService
@inject IJSRuntime JSRuntime

<PageTitle>My RSVPs - Campus Connect Hub</PageTitle>

<div class="content-header text-center mb-4">
    <h1 class="display-4 fw-bold text-primary">My RSVPs</h1>
    <p class="lead text-secondary">Events you've registered for</p>
</div>

<div class="container-fluid rsvps-container">
    @if (!isAuthenticated)
    {
        <div class="card shadow-sm text-center py-5">
            <div class="card-body">
                <i class="bi bi-lock-fill display-4 text-tertiary mb-3"></i>
                <h2 class="h4 text-primary mb-3">Please log in</h2>
                <p class="text-secondary mb-4">You need to be logged in to view your RSVPs.</p>
                <a href="/login" class="btn btn-primary">Go to Login</a>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="loading-spinner mb-3"></div>
            <p class="text-secondary">Loading your RSVPs...</p>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-center gap-2 mb-4">
            <button class="btn @(filterType == "all" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetFilter("all")'>
                All (@rsvps.Count)
            </button>
            <button class="btn @(filterType == "upcoming" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetFilter("upcoming")'>
                Upcoming (@upcomingCount)
            </button>
            <button class="btn @(filterType == "past" ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetFilter("past")'>
                Past (@pastCount)
            </button>
        </div>

        @if (filteredRSVPs.Any())
        {
            <div class="dashboard-grid">
                @foreach (var rsvp in filteredRSVPs)
                {
                    <div class="card rsvp-card h-100">
                        <div class="card-body">
                            <div class="d-flex gap-3 mb-3">
                                <div class="date-badge">
                                    <span class="month">@rsvp.EventDate.ToString("MMM")</span>
                                    <span class="day">@rsvp.EventDate.Day</span>
                                </div>
                                <div class="flex-grow-1">
                                    <h3 class="card-title h5 text-primary mb-1">@rsvp.EventTitle</h3>
                                    <div class="text-secondary small">
                                        <i class="bi bi-calendar-event text-tertiary me-1"></i> @rsvp.EventDate.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3 ps-2 border-start border-3 border-primary bg-light p-2 rounded-end">
                                <div class="small text-secondary">
                                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                                    RSVPed on @rsvp.RSVPDate.ToString("MMM dd, yyyy")
                                </div>
                            </div>
                            
                            <div class="mt-auto d-flex justify-content-end pt-2">
                                @if (rsvp.EventDate >= DateTime.UtcNow)
                                {
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => CancelRSVP(rsvp.EventId)">
                                        Cancel RSVP
                                    </button>
                                }
                                else
                                {
                                    <span class="badge bg-secondary text-light">Past Event</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state text-center py-5">
                <div class="empty-icon mb-3">
                    <i class="bi bi-calendar-x display-1 text-tertiary"></i>
                </div>
                <h3 class="text-primary mb-2">No RSVPs found</h3>
                <p class="text-secondary mb-3">@(filterType == "upcoming" ? "You don't have any upcoming events." : filterType == "past" ? "You don't have any past events." : "You haven't RSVPed to any events yet.")</p>
                <a href="/events" class="btn btn-primary">Browse Events</a>
            </div>
        }
    }
</div>

@code {
    private List<RSVPDto> rsvps = new();
    private List<RSVPDto> filteredRSVPs = new();
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private string filterType = "all";
    private int upcomingCount = 0;
    private int pastCount = 0;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            await LoadRSVPs();
        }
        isLoading = false;
    }

    private async Task LoadRSVPs()
    {
        try
        {
            rsvps = await ApiService.GetMyRSVPsAsync();
            UpdateCounts();
            SetFilter(filterType);
        }
        catch
        {
            rsvps = new List<RSVPDto>();
        }
    }

    private void UpdateCounts()
    {
        var now = DateTime.UtcNow;
        upcomingCount = rsvps.Count(r => r.EventDate >= now);
        pastCount = rsvps.Count(r => r.EventDate < now);
    }

    private void SetFilter(string filter)
    {
        filterType = filter;
        var now = DateTime.UtcNow;
        filteredRSVPs = filter switch
        {
            "upcoming" => rsvps.Where(r => r.EventDate >= now).OrderBy(r => r.EventDate).ToList(),
            "past" => rsvps.Where(r => r.EventDate < now).OrderByDescending(r => r.EventDate).ToList(),
            _ => rsvps.OrderBy(r => r.EventDate).ToList()
        };
    }

    private async Task CancelRSVP(int eventId)
    {
        if (await ConfirmCancel())
        {
            var success = await ApiService.CancelRSVPAsync(eventId);
            if (success)
            {
                await LoadRSVPs();
            }
        }
    }

    private async Task<bool> ConfirmCancel()
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to cancel your RSVP?");
    }
}

<style>
    .rsvps-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .rsvp-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .rsvp-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .date-badge {
        text-align: center;
        background-color: var(--bg-secondary);
        padding: 0.5rem 0.75rem;
        border-radius: var(--radius-md);
        min-width: 60px;
        height: fit-content;
        border: 1px solid #e2e8f0;
    }

    .date-badge .month {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--secondary-color);
        line-height: 1;
        margin-bottom: 2px;
    }

    .date-badge .day {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }

    .text-tertiary {
        color: var(--text-tertiary);
    }
</style>


