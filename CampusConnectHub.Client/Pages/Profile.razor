@page "/profile"
@using CampusConnectHub.Client.Services
@using CampusConnectHub.Shared.DTOs
@using System.ComponentModel.DataAnnotations
@inject ApiService ApiService
@inject AuthService AuthService
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@using System

<PageTitle>Profile - Campus Connect Hub</PageTitle>

<div class="content-header text-center mb-4">
    <h1 class="display-4 fw-bold text-primary">My Profile</h1>
    <p class="lead text-secondary">Manage your account information</p>
</div>

<div class="container pb-5">
    @if (isCheckingAuth)
    {
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="loading-spinner mb-3"></div>
            <p class="text-secondary">Checking authentication...</p>
        </div>
    }
    else if (!isAuthenticated)
    {
        <div class="card shadow-sm text-center py-5">
            <div class="card-body">
                <i class="bi bi-lock-fill display-4 text-tertiary mb-3"></i>
                <h2 class="h4 text-primary mb-3">Please log in</h2>
                <p class="text-secondary mb-4">You need to be logged in to view your profile.</p>
                <a href="/login" class="btn btn-primary">Go to Login</a>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="d-flex flex-column align-items-center justify-content-center py-5">
            <div class="loading-spinner mb-3"></div>
            <p class="text-secondary">Loading profile...</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            <!-- Account Stats -->
            <div class="col-12 mb-2">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 border-0 bg-primary bg-opacity-10">
                            <div class="card-body text-center py-4">
                                <h3 class="display-4 fw-bold text-primary mb-0">@userStats.TotalRSVPs</h3>
                                <p class="text-uppercase small fw-bold text-secondary mb-0">Total RSVPs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 border-0 bg-info bg-opacity-10">
                            <div class="card-body text-center py-4">
                                <h3 class="display-4 fw-bold text-info mb-0">@userStats.UpcomingRSVPs</h3>
                                <p class="text-uppercase small fw-bold text-secondary mb-0">Upcoming Events</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100 border-0 bg-secondary bg-opacity-10">
                            <div class="card-body text-center py-4">
                                <h3 class="display-4 fw-bold text-secondary mb-0">@userStats.PastRSVPs</h3>
                                <p class="text-uppercase small fw-bold text-secondary mb-0">Past Events</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Form -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white border-bottom py-3">
                        <h2 class="h5 text-primary mb-0"><i class="bi bi-person-fill me-2"></i>Profile Information</h2>
                    </div>
                    <div class="card-body p-4">
                        <EditForm Model="profileData" OnValidSubmit="UpdateProfile">
                            <DataAnnotationsValidator />
                            <div class="mb-3">
                                <label for="firstName" class="form-label fw-bold small text-uppercase text-secondary">First Name *</label>
                                <InputText id="firstName" @bind-Value="profileData.FirstName" class="form-control" />
                                <ValidationMessage For="@(() => profileData.FirstName)" />
                            </div>
                            <div class="mb-3">
                                <label for="lastName" class="form-label fw-bold small text-uppercase text-secondary">Last Name *</label>
                                <InputText id="lastName" @bind-Value="profileData.LastName" class="form-control" />
                                <ValidationMessage For="@(() => profileData.LastName)" />
                            </div>
                            <div class="mb-4">
                                <label for="email" class="form-label fw-bold small text-uppercase text-secondary">Email *</label>
                                <InputText id="email" @bind-Value="profileData.Email" type="email" class="form-control" />
                                <ValidationMessage For="@(() => profileData.Email)" />
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Saving...</span>
                                    }
                                    else
                                    {
                                        <span>Save Changes</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <!-- Change Password Form -->
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white border-bottom py-3">
                        <h2 class="h5 text-primary mb-0"><i class="bi bi-shield-lock-fill me-2"></i>Change Password</h2>
                    </div>
                    <div class="card-body p-4">
                        <EditForm Model="passwordData" OnValidSubmit="ChangePassword">
                            <DataAnnotationsValidator />
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label fw-bold small text-uppercase text-secondary">Current Password *</label>
                                <InputText id="currentPassword" @bind-Value="passwordData.CurrentPassword" type="password" class="form-control" />
                                <ValidationMessage For="@(() => passwordData.CurrentPassword)" />
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label fw-bold small text-uppercase text-secondary">New Password *</label>
                                <InputText id="newPassword" @bind-Value="passwordData.NewPassword" type="password" class="form-control" />
                                <ValidationMessage For="@(() => passwordData.NewPassword)" />
                                <small class="text-muted">Must be at least 6 characters</small>
                            </div>
                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label fw-bold small text-uppercase text-secondary">Confirm New Password *</label>
                                <InputText id="confirmPassword" @bind-Value="passwordData.ConfirmPassword" type="password" class="form-control" />
                                <ValidationMessage For="@(() => passwordData.ConfirmPassword)" />
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" disabled="@isChangingPassword">
                                    @if (isChangingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Changing...</span>
                                    }
                                    else
                                    {
                                        <span>Change Password</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private UserResponse? currentUser;
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isCheckingAuth = true;
    private bool isSaving = false;
    private bool isChangingPassword = false;
    private UpdateProfileDto profileData = new();
    private ChangePasswordDto passwordData = new();
    private (int TotalRSVPs, int UpcomingRSVPs, int PastRSVPs) userStats = (0, 0, 0);

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        isCheckingAuth = false;
        
        if (!isAuthenticated)
        {
            Navigation.NavigateTo($"/login?returnUrl={Uri.EscapeDataString("/profile")}");
            return;
        }
        
        currentUser = await AuthService.GetUserAsync();
        if (currentUser != null)
        {
            profileData = new UpdateProfileDto
            {
                FirstName = currentUser.FirstName,
                LastName = currentUser.LastName,
                Email = currentUser.Email
            };
            await LoadUserStats();
        }
        isLoading = false;
    }

    private async Task LoadUserStats()
    {
        try
        {
            var rsvps = await ApiService.GetMyRSVPsAsync();
            var now = DateTime.UtcNow;
            userStats = (
                TotalRSVPs: rsvps.Count,
                UpcomingRSVPs: rsvps.Count(r => r.EventDate >= now),
                PastRSVPs: rsvps.Count(r => r.EventDate < now)
            );
        }
        catch
        {
            // Handle error silently
        }
    }

    private async Task UpdateProfile()
    {
        isSaving = true;
        try
        {
            var response = await ApiService.UpdateProfileAsync(profileData);
            if (response != null)
            {
                // Update stored token and user data
                await LocalStorage.SetItemAsync("authToken", response.Token);
                await LocalStorage.SetItemAsync("user", response.User);
                currentUser = response.User;
            }
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ChangePassword()
    {
        isChangingPassword = true;
        try
        {
            var success = await ApiService.ChangePasswordAsync(passwordData);
            if (success)
            {
                passwordData = new ChangePasswordDto();
                // Show success message
            }
        }
        finally
        {
            isChangingPassword = false;
        }
    }
}

<style>
    .text-tertiary {
        color: var(--text-tertiary);
    }
</style>


